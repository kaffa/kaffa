<!DOCTYPE html>
<html lang="zh-cn">
<head>
      <title>Kaffa.im - 如何编写一个 VSCode 扩展并发布到 Visual Studio Marketplace</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Pelican" />
    <meta name="author" content="Kaffa" />
    <!--
        Q1. 本站技术栈？
        A1. 本站目前版本V2，主要技术栈有 reStructuredText, Markdown, Pelican, kaffa-theme, Bulma, Github Pages

        Q2. 更多信息？
        A2. 微信公众号：Kaffa
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/bulma/css/bulma.min.css">
    <link rel="stylesheet" href="/css/bulma-divider.min.css">
    <link rel="stylesheet" href="/css/0.css">




    <meta name="tags" content="随笔" />
    <meta name="tags" content="Essays" />
    <meta name="tags" content="技术" />
    <meta name="tags" content="Technology" />
    <meta name="tags" content="VSCode Extension" />
    <meta name="tags" content="vsce" />
    <meta name="tags" content="Visual Studio Marketplace" />

</head>
<body>
    <header>
        <nav class="navbar container is-max-widescreen" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
                <h1 class="navbar-item"><a href="./">
                    Kaffa.im</a>
                </h1>
              <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
              </a>
            </div>
            <div class="navbar-menu">
                <div class="navbar-start">
                </div>
                <div class="navbar-end">
                    <div class="navbar-item has-dropdown is-hoverable">
                        <a class="navbar-link">笔记</a>
                        <div class="navbar-dropdown">
                            <a class="navbar-item" href="javascript:;">网站</a>
                            <hr class="navbar-divider">
                            <a class="navbar-item" href="javascript:;">读书</a>
                        </div>
                    </div>
                    <div class="navbar-item has-dropdown is-hoverable">
                        <a class="navbar-link">创作</a>
                        <div class="navbar-dropdown">
                            <a class="navbar-item" href="javascript:;">文章</a>
                            <hr class="navbar-divider">
                            <a class="navbar-item" href="javascript:;">书单</a>
                            <hr class="navbar-divider">
                            <a class="navbar-item" href="javascript:;">周报</a>
                            <hr class="navbar-divider">
                            <a class="navbar-item" href="javascript:;">概念</a>
                        </div>
                    </div>
                    <div class="navbar-item has-dropdown is-hoverable">
                        <a class="navbar-link">我的</a>
                        <div class="navbar-dropdown">
                            <a class="navbar-item" href="javascript:;">书</a>
                            <a class="navbar-item" href="javascript:;">影</a>
                            <a class="navbar-item" href="javascript:;">音</a>
                            <hr class="navbar-divider">
                            <a class="navbar-item" href="javascript:;">物</a>
                        </div>
                    </div>
                    <div class="navbar-item has-dropdown is-hoverable">
                        <a class="navbar-link">关于</a>
                        <div class="navbar-dropdown">
                            <a class="navbar-item" href="/pages/about.html">站长</a>
                            <hr class="navbar-divider">
                            <a class="navbar-item" href="mailto:admin@kaffa.im?subject=Hello%20from%20&body=你好，">联系</a>
                            <hr class="navbar-divider">
                            <a class="navbar-item" href="mailto:admin@kaffa.im?subject=Hello%20from%20&body=网站反馈：">网站反馈</a>
                        </div>
                    </div>
                    <!--
                    <div class="navbar-item">
                        <div class="buttons">
                            <a class="button is-primary">
                            <strong>Sign up</strong>
                            </a>
                            <a class="button is-light">
                            Log in
                            </a>
                        </div>
                    </div>
                    -->
                </div>
            </div>
        </nav>
    </header>
    <main class="has-background-grey-lighter">
  <header>
    <h1 class="entry-title">
      <a href="./how-to-create-a-vscode-extension-and-publish-it-to-visualstudio-marketplace.html" rel="bookmark"
         title="Permalink to 如何编写一个 VSCode 扩展并发布到 Visual Studio Marketplace">如何编写一个 VSCode 扩展并发布到 Visual Studio Marketplace</a></h1>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2019-07-23T12:00:00+08:00">
      2019-07-23 周二
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="./author/kaffa.html">Kaffa</a>
    </address>
    <div class="category">
        Category: <a href="./category/sui-bi.html">随笔</a>
    </div>
    <div class="tags">
        Tags:
            <a href="./tag/sui-bi.html">随笔</a>
            <a href="./tag/essays.html">Essays</a>
            <a href="./tag/ji-zhu.html">技术</a>
            <a href="./tag/technology.html">Technology</a>
            <a href="./tag/vscode-extension.html">VSCode Extension</a>
            <a href="./tag/vsce.html">vsce</a>
            <a href="./tag/visual-studio-marketplace.html">Visual Studio Marketplace</a>
    </div>
  </footer><!-- /.post-info -->
  <article>
    <img alt="编写 VSCode 插件" src="https://kaffa.im/img/2019/create-vscode-extension.png" />
<div class="section" id="section-1">
<h2>概述</h2>
<p>本文假设你熟悉 node.js 和 npm 工具，用过 Git，并懂点 JavaScript，那么本文将一步步教你编写一个 VSCode 扩展，并发布到微软 Visual Studio Marketplace。</p>
<p>VSCode 已是免费文本编辑器/IDE的王者，但其文本闪改能力还是不如一些老牌文本编辑器，比如 <a class="reference external" href="http://www.everedit.net/">EverEdit</a> 与 EmEditor，但它免费呀，所以，用它用它用它。</p>
<p>在文本中插入文件名是个常用场景，比如编辑本文时，第一行就会用到，笔者在 EverEdit 和 EmEditor 中编写过脚本插件，基本都只需要一个文件和几行脚本代码。</p>
<p>考虑到 VSCode 有一个全球生态，那么 Visual Studio Marketplace 中是否能找到一个类似的插件呢，答案是：没有。于是，我们做一个呗。</p>
<img alt="If not me, who? If not now, when?" src="https://kaffa.im/img/2019/if-not-me-who-if-not-now-when.png" />
<p>在 VSCode 关于中，我们可以看到它的技术栈如下，其插件采用 JavaScript 或 TypeScript 编写。</p>
<ul class="simple">
<li>Electron: 4.2.5</li>
<li>Chrome: 69.0.3497.128</li>
<li>Node.js: 10.11.0</li>
<li>V8: 6.9.427.31-electron.0</li>
</ul>
</div>
<div class="section" id="section-2">
<h2>具体步骤</h2>
<p>1、假设你已安装 node.js 和 git</p>
<p>2、如果你没有用过 Yeoman 脚手架工具，那么现在正是时候，装上它:</p>
<pre class="literal-block">
npm install -g yo generator-code
</pre>
<p>3、利用 Yeoman 建立项目框架:</p>
<pre class="literal-block">
yo code

# ? What type of extension do you want to create? New Extension (TypeScript)
# ? What's the name of your extension? insert-filename
### Press &lt;Enter&gt; to choose default for all options below ###
# ? What's the identifier of your extension? insert-filename
# ? What's the description of your extension?
# ? Initialize a git repository? Yes
# ? Which package manager to use? npm
</pre>
<p>扩展项目就创建好了，下一步，让我们运行起来。</p>
<p>4、执行:</p>
<pre class="literal-block">
code ./insert-filename
</pre>
<p>再按 <tt class="docutils literal">F5</tt> 运行，这时，VSCode 会启动一个新窗口，这个窗口中 Yeoman 脚手架项目 insert-filename 已经加载了插件。</p>
<p>5、让我们按下 <tt class="docutils literal">Ctrl + Shift + P</tt>，输入 <tt class="docutils literal"><span class="pre">insert-filename</span></tt>，可以看到这条命令，回车后应该可以看到一条 Hello World！的信息在 VSCode 的右下角弹出来。</p>
<p>6、接着，我们便可以开始编写插入文件名的代码了，还可以调试哟！让我们打开 <tt class="docutils literal">src/extension.ts</tt> 文件。为便于理解，请参阅中文注释:</p>
<pre class="literal-block">
import { commands, workspace, window, ExtensionContext } from 'vscode';

// 在所有选区中插入文件名
function replaceEditorSelection() {
    const editor = window.activeTextEditor;
    if (editor === undefined) {
        return;
    }
    const selections = editor.selections;
    editor.edit((editBuilder) =&gt; {
    selections.forEach((selection) =&gt; {
        let url = editor.document.fileName;
        let urlFormatted = url.replace(/\\/g, '/');
        let lastPart = urlFormatted.split('/').pop() || '';
        editBuilder.replace(selection, '');
        editBuilder.insert(selection.active, lastPart);
    });
    );
}

// 插件激活
export function activate(context: ExtensionContext) {
    console.log('Congratulations, your extension &quot;Insert Filename&quot; is now active!');
    // 注册一条命令
    let disposable = commands.registerCommand('extension.insertFilename', () =&gt; replaceEditorSelection());

    context.subscriptions.push(disposable);
}

// 插件待用
export function deactivate() {
    console.log('Your extension &quot;Insert Filename&quot; is now inactive!');
}
</pre>
<p>7、其次，最重要的是编辑 package.json 文件，最重要的 contributes 配置，以下配置分别在命令、编辑器右键菜单上注册了此命令，并设置其快捷键:</p>
<pre class="literal-block">
&quot;contributes&quot;: {
    &quot;commands&quot;: [
        {
            &quot;command&quot;: &quot;extension.insertFilename&quot;,
            &quot;title&quot;: &quot;Insert Filename&quot;
        }
    ],
    &quot;menus&quot;: {
        &quot;editor/context&quot;: [
            {
                &quot;command&quot;: &quot;extension.insertFilename&quot;,
                &quot;group&quot;: &quot;extension&#64;1&quot;
            }
        ]
    },
    &quot;keybindings&quot;: [
        {
            &quot;command&quot;: &quot;extension.insertFilename&quot;,
            &quot;key&quot;: &quot;ctrl+alt+i&quot;,
            &quot;mac&quot;: &quot;shift+cmd+i&quot;,
            &quot;when&quot;: &quot;editorTextFocus&quot;
        }
    ]
}
</pre>
<p>8、更详细的代码和配置文件请移步 GitHub 仓库：<a class="reference external" href="https://github.com/kaffa/vscode-insert-filename">vscode-insert-filename 插件源码</a> 。</p>
</div>
<div class="section" id="section-3">
<h2>编译发布</h2>
<p>到目前为止，我们的测试都是直接运行插件，现在让我们对项目进行编译，得到 insert-filename-0.0.2.vsix 文件，就可以进行发布了。</p>
<p>9、为编译插件，我们需要下载微软 VSCode Extension 工具 vsce:</p>
<pre class="literal-block">
npm install -g vsce
</pre>
<p>10、安装完毕后，让我们执行如下指令进行编译:</p>
<pre class="literal-block">
vsce package
</pre>
<p>11、编译成功后，项目目录中会得到 insert-filename-0.0.2.vsix 文件，再运行如下命令发布:</p>
<pre class="literal-block">
vsce publish
</pre>
<p>不出意料，你会得到 401 错误，是因为向微软市场发布这个插件，需要一个 <a class="reference external" href="https://aka.ms/SignupAzureDevOps">Azure DevOps</a> 账号，你可以用一个 Microsoft 账号登录跳转注册 <a class="reference external" href="https://aka.ms/SignupAzureDevOps">Azure DevOps</a> 即可。</p>
<p>接下来，我们不用创建项目，直接在右上角个人头像菜单 <tt class="docutils literal">Security</tt> 中创建一个 Personal Access Tokens，选项如下，先点击 <tt class="docutils literal">Show all scopes</tt></p>
<ul class="simple">
<li>Organization：All accessible organization</li>
<li>Scopes: Marketplace 中的 Acquire and Manage</li>
</ul>
<p>再点击 <tt class="docutils literal">Create</tt> 按钮，生成成功后，点击 <tt class="docutils literal">Copy</tt>，<strong>注意</strong>：这个Token只会在这个时候出现一次，所以，你得找一个不会忘记的地方记录下来。</p>
<p>再执行此命令，将其中的 kaffa 换成你的 id，输入刚才创建的 Token:</p>
<pre class="literal-block">
vsce create-publisher kaffa
</pre>
<p>12、发布:</p>
<pre class="literal-block">
vsce publish
</pre>
<p>到这里，我们的插件就发布成功了，过几分钟，就可以官网看到你的插件了，并可以在 VSCode 插件中搜索了，记得做一些关键字 SEO，并升级一下版本。</p>
</div>
<div class="section" id="section-4">
<h2>总结</h2>
<p>本插件发布在 <a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=kaffa.insert-filename">Visual Studio Marketplace</a>，欢迎下载使用。</p>
<p>祝各位读者读完本文，能顺利安装、编写、编译、发布你的插件，如果在具体步骤中遇到问题，请回复和留言。</p>
<p>感谢观阅，如果您觉得有用，可以扫我的赞赏码，鼓励一杯咖啡。</p>
<img alt="我的赞赏码" src="https://kaffa.im/img/reward.png" />
</div>

  </article>
    </main>
    <footer class="footer is-max-widescreen">
        <div class="content has-text-centered">
            Copyright &copy; 2018-2013 <strong>Kaffa.im</strong> by <a href="https://kaffa.im">Kaffa</a>.
            <p>The templates code is licensed
            <a href="http://opensource.org/licenses/mit-license.php">MIT</a>. The website content
            is licensed <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY NC SA 4.0</a>.
            </p>
        </div>
    </footer>
</body>

</html>